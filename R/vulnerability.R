# R/vulnerability.R

# =============================================================================
# VULNERABILITY DYNAMICS
# =============================================================================

#' @title Compute Community Protection
#' @description Calculates the community protection status for each agent based
#'   on the proportion of adaptive neighbors within their local network.
#' @param agents A data.frame of agents, including their `migrated` status and `behavior`.
#' @param network The igraph network object representing agent connections.
#' @param params List, simulation parameters including `theta_comm` (community protection threshold).
#' @return A numeric vector, where 1 indicates an agent is protected by their community, 0 otherwise.

compute_community_protection <- function(agents, network, params) {
  N <- nrow(agents)
  protection <- rep(0, N) # Initialize protection status for all agents
  
  for (i in 1:N) {
    if (agents$migrated[i]) {
      protection[i] <- 0 # Migrated agents do not receive community protection
      next
    }
    
    # Get all neighbors of the current agent 'i'
    neighbors_of_i <- igraph::neighbors(network, i, mode = "all")
    
    if (length(neighbors_of_i) == 0) {
      protection[i] <- 0 # No neighbors means no community protection
      next
    }
    
    # Filter to only consider active (non-migrated) neighbors
    active_neighbors_of_i <- neighbors_of_i[!agents$migrated[neighbors_of_i]]
    
    if (length(active_neighbors_of_i) == 0) {
      protection[i] <- 0 # No active neighbors means no community protection
    } else {
      # Count how many active neighbors are 'Adaptive'
      adaptive_neighbors_count <- sum(agents$behavior[active_neighbors_of_i] == "A")
      total_active_neighbors_count <- length(active_neighbors_of_i)
      
      # Determine if community protection threshold is met (binary protect = 1 if so, otherwise 0)
      protection[i] <- ifelse(adaptive_neighbors_count / total_active_neighbors_count >= params$theta_comm, 1, 0)
    }
  }
  
  protection
}

#' @title Update Agent Vulnerabilities
#' @description Updates the vulnerability level of each active agent based on
#'   disaster occurrence, their behavior, and their community protection status.
#' @param agents A data.frame of agents, including their `vulnerability`, `behavior`, and `migrated` status.
#' @param network The igraph network object.
#' @param disaster A list containing `occurs` (logical) and `severity` (numeric) of the current disaster.
#' @param params List, simulation parameters including `c`, `gamma`, and `v_mig`.
#' @return The updated agents data.frame.
update_vulnerabilities <- function(agents, network, disaster, params) {
  # The impact of disaster on vulnerability; 0 if no disaster
  disaster_impact <- if (disaster$occurs) disaster$severity else 0
  
  # Compute community protection for all agents in the current step
  comm_protect <- compute_community_protection(agents, network, params)
  
  for (i in 1:nrow(agents)) {
    if (agents$migrated[i]) {
      next # Migrated agents do not have their vulnerability updated
    }
    
    behavior <- agents$behavior[i]
    protected <- comm_protect[i] # Community protection status for agent 'i'
    
    # Apply vulnerability updates based on behavior and protection status
    if (protected == 0) { # Agent is NOT protected by community
      if (behavior == "L") {
        agents$vulnerability[i] <- agents$vulnerability[i] + disaster_impact
      } else if (behavior == "A") {
        agents$vulnerability[i] <- agents$vulnerability[i] + (disaster_impact - params$gamma)
      }
    } else { # protected == 1, Agent IS protected by community
      if (behavior == "L") {
        agents$vulnerability[i] <- agents$vulnerability[i] + (disaster_impact - params$c)
      } else if (behavior == "A") {
        agents$vulnerability[i] <- agents$vulnerability[i] + (disaster_impact - params$c - params$gamma)
      }
    }
    
    # Clamp vulnerability: ensure it stays non-negative and does not exceed migration threshold
    agents$vulnerability[i] <- max(0, min(agents$vulnerability[i], params$v_mig))
    
    # Check whether to migrate 
    if (agents$vulnerability[i]>= params$v_mig){
      agents$migrated[i] == TRUE
    }
  }
  
  agents
}